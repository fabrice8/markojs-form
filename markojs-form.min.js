/** Form Handler for @Markojs
 * 
 * @version 1.0.0
 * @author Fabrice Marlboro
 * @date 15/04/2021
 * @repository https://github.com/fabrice8/markojs-form
 * 
 * @params options (Object)
 * 		- key: <string> Scope identifier key of the form Element in the component
 * 		- autosave: <true|false> Put the form on auto-save mode while the user is filling it.
 * 		- crosscheck: <true|false> Re-test the validation patterns of each inputs in the form before submission
 * 
 * @Dependencies
 * 		- UIStore Plugin for the auto-save feature. Check https://github.com/fabrice8/ui-store
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _allLocalstorage=_interopRequireDefault(require("all-localstorage"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function Patterns(){const t=this,e={required:t=>/[a-zA-Z0-9]/.test(t),domain:t=>/^((http(s?)|ftp):\/\/)?[\w-]+(\.[\w-]+)/i.test(t),url:t=>/^((http(s?)|ftp):\/\/)?[\w-]+(\.[\w-]+)+([\w.,@?^=%&:\/~+#-]*[\w@?^=%&\/~+#-])?/i.test(t),email:t=>/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9._-]+\.[a-zA-Z]{2,6}$/i.test(t),phone:e=>t.number&&/\d{7,}|(\d{2,} ) => {3,}/.test(e),fullname:t=>/\s+/.test(t),password:(t,e)=>{let r,o={weak:1,medium:2,strong:3,perfect:4},s=0;return/(?=.*[a-z].*[a-z].*[a-z])/.test(t)&&s++,/(?=.*[!@#$&*])/.test(t)&&s++,/(?=.*[A-Z].*[A-Z])/.test(t)&&s++,/(?=.*[0-9].*[0-9])/.test(t)&&s++,/.{12,20}/.test(t)?s+=2:/.{8,12}/.test(t)&&s++,s>=0&&s<2?r={type:"weak",indice:1}:s>=2&&s<4?r={type:"medium",indice:2}:s>=4&&s<6?r={type:"strong",indice:3}:s>=6&&(r={type:"perfect",indice:4}),o.hasOwnProperty(e)&&o[e]<=r.indice},number:t=>"number"==typeof t||null!==Number(t),boolean:t=>"boolean"==typeof t,array:t=>Array.isArray(t),object:t=>"object"==typeof t&&!Array.isArray(t),lowercase:t=>t.toLowerCase()==t,uppercase:t=>t.toUpperCase()==t,length:(t,e)=>t.length==parseInt(e),minLength:(t,e)=>t.length>=parseInt(e),maxLength:(t,e)=>t.length<=parseInt(e)},r={};function o(t){let e=t.split(/\s*:\s*/);return 2==e.length?e:[t,!1]}function s(t,o,s){return!(!e.hasOwnProperty(o)&&!r.hasOwnProperty(o))&&(e.hasOwnProperty(o)&&e[o](t,s)||r.hasOwnProperty(o)&&new RegExp(r[o]).test(t))}this.add=(t,e)=>r[t]=e,this.has=t=>e.hasOwnProperty(t)||r.hasOwnProperty(t),this.test=(e,r)=>{if(/\|/.test(e)){return e.split(/\s*\|\s*/).map((e=>t.test(e,r))).includes(!0)}if(/\s+/.test(e))return t.multiTest(e.split(/\s+/g),r);{let[t]=o(e);return s(r,e,t)}},this.multiTest=(t,e,r)=>{let i=!1;if(t.length)for(let r=0;r<t.length;r++){let[n,a]=o(t[r]);if(!s(e,n,a)){i=!1;break}i=!0}return i}}function getAttributes(t,e){const r=t.pop();let o,s,i;if("function"==typeof r.getAttribute?(o="number"==r.getAttribute("type")?parseInt(r.value):r.value,s=r.getAttribute("name"),i=r.getAttribute("validate")):(o=t.pop()||r.input.value,s=r.input.name,i=r.input.validate),"checked"===e)o=r.checked;return{value:o,name:s,pattern:i}}function subSet(t,e,r){const o=e.split("."),s=o.shift();return!t.hasOwnProperty(s)&&o.length&&(t[s]={}),"object"==typeof t&&o.length?subSet(t=t[s],o.join("."),r):(t[s]=r,!0)}let PEvents=["bind","unbind","input","error","fill","autosave","reset"];const autofillStore=new _allLocalstorage.default({prefix:"fh--auto-fill",encrypt:!0});function FormHandler(t){const e=this,r={};let o;if(this.options=Object.assign({},{autosave:!1,crosscheck:!0},t||{}),this.options.autosave){if(!this.options.key)throw new Error("[FormHandler] Undefined Form Key Identifier. Required for Auto-Save");autofillStore&&(o=autofillStore.get(this.options.key)||{})}function s({value:t,name:r,pattern:o}){e.set(r,t),e.formError[r]=!1,o&&!e.Patterns.test(o,t)&&(e.formError[r]=!0,a("error",[r,t])),e.component.setStateDirty("formError",e.formError)}function i({name:t,regexp:r}){if(!t||!r)throw new Error("Invalid Pattern Defined. { <name>, <regexp> } expected");r=String(r).replace(/^\/|\/$/g,"");try{new RegExp(r)}catch(t){throw new Error("Invalid Regular Expression: ",t)}return e.Patterns.add(t,r),t}function n(){e.options.key&&e.options.autosave&&(autofillStore.set(e.options.key,e.form),a("autosave",[e.form]))}function a(t,e){r.hasOwnProperty(t)&&r[t].map((t=>Array.isArray(e)?t(...e):t()))}this.form={},this.initForm={},this.formError={},this.formPatterns={},this.Patterns=new Patterns,this.bind=(t,e)=>{if(this.component=t,this.initForm=e||{},this.form=Object.assign({},this.initForm,o),t.setState({form:this.form,formError:this.formError}),this.options.key){let e;t.on("mount",(()=>{(e=t.getEl(this.options.key))&&(e.onsubmit=t=>t.preventDefault())})).on("update",(()=>{e||(e=t.getEl(this.options.key))&&(e.onsubmit=t=>t.preventDefault())}))}return t.__onInput=(...t)=>s(getAttributes(t,"input")),t.__onChange=(...t)=>s(getAttributes(t,"change")),t.__onSelect=(...t)=>s(getAttributes(t,"select")),t.__onChecked=(...t)=>s(getAttributes(t,"checked")),a("bind"),this},this.unbind=t=>(delete(t=t||this.component).form,delete t.formError,delete t.__onInput,delete t.__onChange,delete t.__onSelect,delete t.__onChecked,a("unbind"),this),this.set=(t,e)=>(/\./.test(t)?subSet(this.form,t,e):this.form[t]=e,this.component.setStateDirty("form",this.form),a("input",[t,e]),this.options.autosave&&autofillStore&&n(),this),this.fill=t=>{if("object"==typeof t)return this.component.setStateDirty("form",Object.assign(this.form,t)),a("fill",[this.form]),this.options.autosave&&autofillStore&&n(),this},this.error=(t,e)=>(this.formError[t]=e,this.component.setStateDirty("formError",this.formError),a("error",[t,e]),this),this.reset=()=>(this.form={},this.formError={},this.component.setState({form:this.initForm,formError:this.formError}),autofillStore&&e.options.key&&autofillStore.clear(e.options.key),a("reset"),this),this.alert=(t,e)=>{if(!t)return;this.component.setStateDirty("alert",{type:e||"info",message:t});const r=setTimeout((()=>{this.component.setState("alert",null),clearTimeout(r)}),15e3);return this},this.define=t=>{if("string"==typeof t)return t.split(/\s+|\|/).map((t=>{const e=t.replace(/:(.+)$/,"");if(!this.Patterns.has(e))throw new Error("<"+t+"> is not a Predefined Validation Patterm")})),t;let e=[];return Array.isArray(t)?t.map((t=>e.push(i(t)))):"object"==typeof t&&e.push(i(t)),e.join(" ")},this.validate=(t,e)=>this.Patterns.test(t,e),this.on=(t,e)=>{if(PEvents.includes(t))return r.hasOwnProperty(t)?r[t].push(e):r[t]=[e],this},this.off=t=>(delete r[t],this),this.removeListeners=()=>(r={},this)}var _default=FormHandler;exports.default=_default;